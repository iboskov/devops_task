name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - '.github/workflows/**'

env:
  # DockerHub registry
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  # ACR registry:
  # REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      sha_short: ${{ steps.vars.outputs.sha_short }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'app/frontend/**'
            backend:
              - 'app/backend/**'

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # DockerHub login
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ACR login:
      # - name: Login to Azure Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ${{ secrets.ACR_LOGIN_SERVER }}
      #     username: ${{ secrets.ACR_USERNAME }}
      #     password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./app/frontend
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/demo_frontend:${{ needs.detect-changes.outputs.sha_short }}
            ${{ env.DOCKERHUB_USERNAME }}/demo_frontend:latest
          # ACR tags:
          # tags: |
          #   ${{ secrets.ACR_LOGIN_SERVER }}/demo-frontend:${{ needs.detect-changes.outputs.sha_short }}
          #   ${{ secrets.ACR_LOGIN_SERVER }}/demo-frontend:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # DockerHub login
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ACR login::
      # - name: Login to Azure Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ${{ secrets.ACR_LOGIN_SERVER }}
      #     username: ${{ secrets.ACR_USERNAME }}
      #     password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./app/backend
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/demo_backend:${{ needs.detect-changes.outputs.sha_short }}
            ${{ env.DOCKERHUB_USERNAME }}/demo_backend:latest
          # ACR tags:
          # tags: |
          #   ${{ secrets.ACR_LOGIN_SERVER }}/demo-backend:${{ needs.detect-changes.outputs.sha_short }}
          #   ${{ secrets.ACR_LOGIN_SERVER }}/demo-backend:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

  update-helm-values:
    name: Update Helm Values
    runs-on: ubuntu-latest
    needs: [detect-changes, build-frontend, build-backend]
    if: always() && (needs.build-frontend.result == 'success' || needs.build-backend.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Frontend image tag
        if: needs.build-frontend.result == 'success'
        run: |
          TAG="${{ needs.detect-changes.outputs.sha_short }}"
          sed -i '/^frontend:/,/^backend:/{s|tag:.*|tag: "'$TAG'"|;}' helm/demo-app/values.yaml

      - name: Update Backend image tag
        if: needs.build-backend.result == 'success'
        run: |
          TAG="${{ needs.detect-changes.outputs.sha_short }}"
          sed -i '/^backend:/,/^postgres:/{s|tag:.*|tag: "'$TAG'"|;}' helm/demo-app/values.yaml

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add helm/demo-app/values.yaml
          git diff --staged --quiet || git commit -m "chore: update image tags to ${{ needs.detect-changes.outputs.sha_short }}"
          git push
